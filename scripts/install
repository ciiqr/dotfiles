#!/usr/bin/env bash

set -e

forrealz(){ realpath "$@" 2>/dev/null || readlink -f "$@"; }
srcDir="$(dirname "$(forrealz "${BASH_SOURCE[0]}")")"

# download and run
if [[ "$srcDir" == '.' ]]; then
	tmp=$(mktemp -d)

	cleanup()
	{
	    [[ -f "$tmp" ]] && rm -rf "$tmp"
	}
	trap cleanup EXIT

	# download
	curl -sL 'https://github.com/ciiqr/config/archive/master.zip' -o "$tmp/config.zip"
	unzip -qq "$tmp/config.zip" -d "$tmp"

	# install
	"$tmp/config-master/scripts/install" "$@" --copy
	exit "$?"
fi

. "$srcDir/include/common.sh"

parse_cli_args "$@" || usage "$0"

ensureRoot


srcRoot="${srcDir%/scripts}"

if [[ "$srcRoot" -ef "$configDir" ]]; then
	echo "running from config directory already"
else
	rm -rf "$configDir"
	if [[ "$link" == "true" ]]; then
		ln -sf "$srcRoot" "$configDir"
	else
		cp -r "$srcRoot" "$configDir"
	fi
fi

# bootstrap salt
if [[ "$OSTYPE" == darwin* ]]; then
	easy_install pip
	pip install 'salt>=2017.7.0,<2018.0.0'
else
	curl -sL https://bootstrap.saltstack.com | sh -s -- -X stable 2017.7
fi

"$srcDir/setup-salt" "$@"

"$srcDir/provision"
