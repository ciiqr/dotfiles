#!/usr/bin/env bash

set -e

forrealz(){ realpath "$@" 2>/dev/null || readlink -f "$@"; }
srcDir="$(dirname "$(forrealz "${BASH_SOURCE[0]}")")"

# download and run
if [[ "$srcDir" == '.' ]]; then
    tmp=$(mktemp -d)

    cleanup()
    {
        [[ -f "$tmp" ]] && rm -rf "$tmp"
    }
    trap cleanup EXIT

    if type curl >/dev/null 2>&1; then
        download_cmd="curl -sL"
    elif type wget >/dev/null 2>&1; then
        download_cmd="wget -O -"
    fi

    if [[ -z "$download_cmd" ]]; then
        echo "no download command found" 1>&2
        exit 1
    fi

    # download
    $download_cmd 'https://github.com/ciiqr/config/archive/master.zip' -o "$tmp/config.zip"
    unzip -qq "$tmp/config.zip" -d "$tmp"

    # install
    "$tmp/config-master/scripts/install" "$@" --copy
fi

. "$srcDir/include/common.sh"

parse_cli_args "$@" || usage "$0"

ensureRoot


srcRoot="${srcDir%/scripts}"

if [[ "$srcRoot" -ef "$configDir" ]]; then
    echo "running from config directory already"
else
    if [[ -e "$configDir" ]]; then
        confirm "This will delete the file located at: $configDir"
    fi
    rm -rf "$configDir"
    if [[ "$link" == "true" ]]; then
        ln -sf "$srcRoot" "$configDir"
    else
        cp -r "$srcRoot" "$configDir"
    fi
fi

# bootstrap salt
if [[ "$OSTYPE" == darwin* ]]; then
    # install pipenv
    easy_install pip
    pip install pipenv

    # install salt inside pipenv
    pipenv install

    # wrap `pipenv run salt-call`
    tee "/usr/local/bin/salt-call" > /dev/null <<EOF
    cd "$configDir"
    pipenv run \$(basename \$0) "\$@"
EOF

    # make sure it's executable
    chmod +x /usr/local/bin/salt-call
else
    get_download_cmd
    $download_cmd https://bootstrap.saltstack.com | sh -s -- -X stable 2017.7.3
fi

"$srcDir/setup-salt" "$@"

"$srcDir/provision"
