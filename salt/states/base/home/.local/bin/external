#!/usr/bin/env bash

set -e

declare repo="$1"
if [[ -z "$repo" ]]; then
    echo "usage: $0 <repo>"
    exit 1
fi

# extract directory path from repo
# NOTE: sed doesn't support non-greedy matching, previously had: sed -E 's#^(https?://|git@)[^/:]+[/:]([^.]+)(\.git)?$#\2#g'
declare directory="$(perl -pe 's#^(https?://|git@)[^/:]+[/:](.*?)(\.git)?$#\2#g' <<< "$repo")"

# clone to ~/External
git clone "$repo" "${HOME}/External/${directory}"

# find project template
declare configDir="$(sudo salt-call --local --out newline_values_only grains.get configDir)"
declare projectTemplate="${configDir}/salt/states/development/files/external.sublime-project"

# create project file
cat "$projectTemplate" | sed 's@{{ folder }}@'"$directory"'@g' \
    > "${HOME}/External/.sublime/external-$(tr '/' '-' <<< "$directory").sublime-project"

# TODO: move to git.sh
# TODO: create alias clone-external
# TODO: create a similar command clone-project for cloning and setting up in ~/Projects/
# TODO: consider how we handle project dir existing already (maybe if already exists with correct remove, just skip?)
# git remote | xargs -n1 git remote get-url
# git remote get-url origin
