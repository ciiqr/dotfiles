#!/usr/bin/env bash

set -e

declare repo="$1"
if [[ -z "$repo" ]]; then
    echo "usage: $0 <repo>"
    exit 1
fi

# TODO: currently this supports full repo urls, but we could also trivially support github names
# url: git@github.com:bitnami/bitnami-docker-postgresql-repmgr.git
# gh name: bitnami/bitnami-docker-postgresql-repmgr

# extract directory path from repo
declare directory="$(sed -E 's#^(https?://|git@)[^/:]+[/:]([^.]+)(\.git)?$#\2#g' <<< "$repo")"

# clone to ~/External
git clone "$repo" "${HOME}/External/${directory}"

# find project template
declare configDir="$(sudo salt-call --local --out newline_values_only grains.get configDir)"
declare projectTemplate="${configDir}/salt/states/development/files/external.sublime-project"

# create project file
cat "$projectTemplate" | sed 's@{{ folder }}@'"$directory"'@g' \
    > "${HOME}/External/.sublime/external-$(tr '/' '-' <<< "$directory").sublime-project"
